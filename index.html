<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Virtual Gene Machine – Maxwell–Scretching v1.3.1</title>
<style>
body{
  font-family:system-ui, Arial, sans-serif;
  background:#f4f7fb;
  padding:20px;
  color:#1f2d3d;
}
.container{max-width:1200px;margin:auto;}
header{
  background:#1f3a5c;
  color:#fff;
  padding:18px 24px;
  border-radius:10px;
}
h1{margin:0;font-size:1.9rem;}
.subtitle{opacity:.85;font-size:.95rem;}

.card{
  background:#fff;
  margin-top:20px;
  padding:20px;
  border-radius:12px;
  box-shadow:0 6px 16px rgba(0,0,0,.10);
}

.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:20px;}
@media(max-width:1000px){.grid{grid-template-columns:1fr;}}

.form-group{margin-bottom:12px;}
label{font-weight:600;display:block;margin-bottom:3px;}
textarea,input{width:100%;padding:9px;border-radius:6px;border:1px solid #ccc;}
textarea{min-height:140px;}

button{
  width:100%;
  padding:11px;
  border:none;
  background:#2980b9;
  color:#fff;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}
button.secondary{background:#555;margin-top:6px;}

.section-title{font-weight:700;margin:12px 0 6px;color:#1f3a5c;}
.results-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(190px,1fr));
  gap:10px;
  margin-top:6px;
}
.result-card{
  background:#ecf0f1;
  padding:10px;
  border-radius:8px;
}
.label{font-size:.78rem;color:#555;}
.value{font-weight:700;margin:4px 0;}
.small{font-size:.8rem;color:#666;}

.monospace{
  font-family:Consolas,"Courier New",monospace;
  background:#f0f3f6;
  padding:8px;
  border-radius:6px;
  word-break:break-all;
}

.error{color:#e74c3c;font-weight:600;display:none;margin-top:6px;}

.ip-box{
  margin-top:20px;
  padding:14px;
  border-radius:10px;
  background:#fcecec;
  border:1px solid #d44;
  font-size:.85rem;
}
footer{
  margin-top:30px;
  font-size:.85rem;
  text-align:center;
  color:#555;
}
</style>
</head>
<body>

<div class="container">

<header>
  <h1>Virtual Gene Machine – Maxwell–Scretching</h1>
  <div class="subtitle">
    ORF • Translation • Primer Design • Maxwell–Scretching EM Analysis (260 nm)
  </div>
</header>

<div class="card">
  <div class="grid">

    <div>
      <div class="form-group">
        <label>DNA Gene Sequence (A/C/G/T)</label>
        <textarea id="dnaSeq">ATGGCCTTTGCGGCGGCGAAATCGGCTGCTGCTGCTGCTGCTGCTAAGGGTAA</textarea>
        <div id="dnaError" class="error">Invalid DNA sequence (only A, C, G, T allowed).</div>
      </div>

      <div class="form-group">
        <label>Concentration c (µM, gene in cuvette)</label>
        <input id="conc_uM" type="number" value="1.0" step="0.1">
      </div>
      <div class="form-group">
        <label>Path Length L (cm)</label>
        <input id="L_cm" type="number" value="1.0" step="0.1">
      </div>
      <div class="form-group">
        <label>Average Refractive Index n̄ (260 nm)</label>
        <input id="n_avg" type="number" value="1.50" step="0.01">
      </div>
      <div class="form-group">
        <label>Monovalent Salt [Na⁺] (mM, for Tm)</label>
        <input id="na_mM" type="number" value="50" step="5">
      </div>

      <button onclick="analyze()">Analyze Gene</button>
      <button class="secondary" onclick="downloadReport()">Download TXT Report</button>
    </div>

    <div id="summaryPanel"></div>

  </div>
</div>

<div class="card">
  <div id="detailPanel"></div>
</div>

<div class="ip-box">
  <b>Intellectual Property & Patent Notice:</b><br>
  © 2025 Daniel C. Scretching, Sr. All Rights Reserved.  
  Maxwell–Scretching™ and Virtual Gene Machine™ are proprietary analytical frameworks.  
  This software constitutes a proof-of-concept scientific instrument protected under U.S. and international intellectual-property law.  
  Reverse engineering, redistribution, or commercial use without express written consent is prohibited.
</div>

<footer>
  Virtual Gene Machine v1.3 – Scientific, Patent, and Investor-Grade Output System
</footer>

</div>

<script>
// Constants
const LN10 = Math.log(10.0);
const AVOG = 6.02214076e23;
const R_GAS = 1.987; // cal·K⁻¹·mol⁻¹ (for NN Tm)

// Fallback log10 (older browsers)
if (!Math.log10) {
  Math.log10 = function(x){ return Math.log(x) / Math.LN10; };
}

// Base ε260 values (M^-1·cm^-1) and approximate refractive indices
const EPS_DNA = { A:15400, G:11500, C:7400, T:8800 };
const N_DNA   = { A:1.54, G:1.55, C:1.49, T:1.50 };

// SantaLucia-style nearest-neighbor parameters (kcal/mol, cal·K⁻¹·mol⁻¹)
const NN_PARAMS = {
  AA:{dH:-7.9,dS:-22.2}, TT:{dH:-7.9,dS:-22.2},
  AT:{dH:-7.2,dS:-20.4}, TA:{dH:-7.2,dS:-21.3},
  CA:{dH:-8.5,dS:-22.7}, TG:{dH:-8.5,dS:-22.7},
  GT:{dH:-8.4,dS:-22.4}, AC:{dH:-8.4,dS:-22.4},
  CT:{dH:-7.8,dS:-21.0}, AG:{dH:-7.8,dS:-21.0},
  GA:{dH:-8.2,dS:-22.2}, TC:{dH:-8.2,dS:-22.2},
  CG:{dH:-10.6,dS:-27.2}, GC:{dH:-9.8,dS:-24.4},
  GG:{dH:-8.0,dS:-19.9}, CC:{dH:-8.0,dS:-19.9}
};

// Codon table (standard genetic code)
const CODON_TABLE = {
  TTT:"F", TTC:"F", TTA:"L", TTG:"L",
  CTT:"L", CTC:"L", CTA:"L", CTG:"L",
  ATT:"I", ATC:"I", ATA:"I", ATG:"M",
  GTT:"V", GTC:"V", GTA:"V", GTG:"V",
  TCT:"S", TCC:"S", TCA:"S", TCG:"S",
  CCT:"P", CCC:"P", CCA:"P", CCG:"P",
  ACT:"T", ACC:"T", ACA:"T", ACG:"T",
  GCT:"A", GCC:"A", GCA:"A", GCG:"A",
  TAT:"Y", TAC:"Y", TAA:"*", TAG:"*",
  CAT:"H", CAC:"H", CAA:"Q", CAG:"Q",
  AAT:"N", AAC:"N", AAA:"K", AAG:"K",
  GAT:"D", GAC:"D", GAA:"E", GAG:"E",
  TGT:"C", TGC:"C", TGA:"*", TGG:"W",
  CGT:"R", CGC:"R", CGA:"R", CGG:"R",
  AGT:"S", AGC:"S", AGA:"R", AGG:"R",
  GGT:"G", GGC:"G", GGA:"G", GGG:"G"
};

function fmt(x, d=3){
  if (!isFinite(x)) return "NaN";
  if (Math.abs(x)<1e-3 && x!==0) return x.toExponential(d);
  return x.toFixed(d);
}

function isValidDNA(seq){
  return /^[ACGT]+$/.test(seq);
}

function gcPercent(seq){
  const n = seq.length;
  if(n===0) return 0;
  let gc = 0;
  for(const b of seq){
    if(b==="G" || b==="C") gc++;
  }
  return 100*gc/n;
}

function epsFromDNA(seq){
  let eps = 0;
  let nSum = 0;
  let N = 0;
  for(const b of seq){
    if(EPS_DNA[b] != null){
      eps += EPS_DNA[b];
      nSum += N_DNA[b];
      N++;
    }
  }
  const n_avg = N>0 ? nSum/N : 1.50;
  return {eps_seq: eps, n_avg};
}

// Maxwell–Scretching EM chain from ε
function msFromEps(eps_seq, c_M, L_cm, n_avg, lambda_nm){
  const lambda_cm = lambda_nm*1e-7;
  // Beer–Lambert (base-10)
  const A = eps_seq*c_M*L_cm;
  // Absorption coefficient α (natural log base)
  const alpha = LN10*eps_seq*c_M;
  // Extinction coefficient κ
  const kappa = alpha*lambda_cm/(4*Math.PI);
  // Imaginary permittivity ε″ᵣ
  const epsImag = 2*n_avg*kappa;
  // Molecular absorption cross-section σ (cm² per molecule)
  const sigma = (1000*LN10/AVOG)*eps_seq;
  // Crude oscillator-strength-like scaling (PoC)
  const f = 2.16e-5*eps_seq;
  return {A, alpha, kappa, epsImag, sigma, f};
}

function findFirstORF(frameSeq){
  const n = frameSeq.length;
  for(let i=0; i<=n-3; i+=3){
    const codon = frameSeq.slice(i,i+3);
    if(codon === "ATG"){
      for(let j=i+3; j<=n-3; j+=3){
        const codon2 = frameSeq.slice(j,j+3);
        if(codon2==="TAA" || codon2==="TAG" || codon2==="TGA"){
          return {start:i, end:j+3};
        }
      }
      // no stop found; run to end
      return {start:i, end:n};
    }
  }
  return null;
}

function translate(seq){
  let protein = "";
  for(let i=0; i<=seq.length-3; i+=3){
    const codon = seq.slice(i,i+3);
    const aa = CODON_TABLE[codon] || "X";
    if(aa === "*") break;
    protein += aa;
  }
  return protein;
}

function revComp(seq){
  const comp = {A:"T", C:"G", G:"C", T:"A"};
  let out = "";
  for(let i=seq.length-1; i>=0; i--){
    const b = seq[i];
    out += comp[b] || "N";
  }
  return out;
}

// Simple Wallace rule
function tmWallace(seq){
  let A=0,C=0,G=0,T=0;
  for(const b of seq){
    if(b==="A") A++;
    else if(b==="C") C++;
    else if(b==="G") G++;
    else if(b==="T") T++;
  }
  return 2*(A+T) + 4*(G+C);
}

// Improved long-oligo formula (standard form with -500/N)
// Tm(°C) = 81.5 + 16.6*log10([Na+]) + 0.41(%GC) - 500/N
function tmGCFormula(seq, salt_M){
  const N = seq.length;
  if(N === 0) return NaN;
  const gcPct = gcPercent(seq);
  const na = (salt_M && salt_M>0) ? salt_M : 0.05; // default 50 mM if not set
  const tm = 81.5 + 16.6*Math.log10(na) + 0.41*gcPct - (500.0/N);
  return tm;
}

// Nearest-neighbor Tm (SantaLucia-style, PoC)
// Uses DNA NN enthalpy/entropy and experimental strand conc c_M.
function tmNN(seq, salt_M, c_M){
  const N = seq.length;
  if(N < 2) return NaN;
  let dH = 0;   // kcal/mol
  let dS = 0;   // cal/(K mol)
  for(let i=0;i<N-1;i++){
    const dimer = seq.slice(i,i+2);
    const p = NN_PARAMS[dimer];
    if(p){
      dH += p.dH;
      dS += p.dS;
    }
  }
  const na = (salt_M && salt_M>0) ? salt_M : 0.05;
  const Ct = (c_M && c_M>0) ? c_M : 0.5e-6; // default 0.5 µM if not specified
  const tmK = (dH*1000.0)/(dS + R_GAS*Math.log(Ct/4.0)) + 16.6*Math.log10(na);
  return tmK - 273.15;
}

// Maxwell–Scretching Tm law (PoC form)
// Links EM extinction κ to Tm; coefficients are tunable via regression.
function tmMS(ms){
  if(!ms || ms.kappa <= 0) return NaN;
  const kref = 1e-6; // reference κ at which Tm ≈ T0
  const T0   = 60.0; // °C baseline (tune from data)
  const a    = 4.0;  // slope (tune from data)
  return T0 + a*Math.log10(kref/ms.kappa);
}

function analyze(){
  const summaryPanel = document.getElementById("summaryPanel");
  const detailPanel  = document.getElementById("detailPanel");
  const errDiv       = document.getElementById("dnaError");

  // Force uppercase and strip invalid characters, write back to textarea
  const rawInput = document.getElementById("dnaSeq").value;
  const cleaned  = rawInput.toUpperCase().replace(/[^ACGT]/g,"");
  document.getElementById("dnaSeq").value = cleaned; // show uppercase sequence

  const raw = cleaned;

  if(!raw || !isValidDNA(raw)){
    errDiv.style.display = "block";
    summaryPanel.innerHTML = "";
    detailPanel.innerHTML = "";
    return;
  }
  errDiv.style.display = "none";

  const conc_uM    = parseFloat(document.getElementById("conc_uM").value || "0");
  const L_cm       = parseFloat(document.getElementById("L_cm").value || "1");
  const n_avg_user = parseFloat(document.getElementById("n_avg").value || "1.5");
  const na_mM      = parseFloat(document.getElementById("na_mM").value || "50");
  const c_M        = conc_uM * 1e-6;
  const salt_M     = na_mM * 1e-3;

  const length_bp = raw.length;
  const gc_gene   = gcPercent(raw);

  // ORF search in frame 1
  const frame1 = raw;
  const orf = findFirstORF(frame1);
  let orfInfo = "No ATG found in frame 1.";
  let protSeq = "";
  if(orf){
    const cds = frame1.slice(orf.start, orf.end);
    protSeq = translate(cds);
    orfInfo = `ORF from bp ${orf.start+1} to ${orf.end} (length ${orf.end-orf.start} bp, ${protSeq.length} aa)`;
  }

  // Gene-level MS
  const {eps_seq: eps_gene, n_avg:n_gene} = epsFromDNA(raw);
  const n_used = isFinite(n_avg_user) ? n_avg_user : n_gene;
  const msGene = msFromEps(eps_gene, c_M, L_cm, n_used, 260);

  // Primers: forward = first 20, reverse = last 20 (rev-comp)
  const pLen = Math.min(20, length_bp);
  const fwd = raw.slice(0, pLen);
  const rev = revComp(raw.slice(length_bp - pLen));

  const gc_fwd = gcPercent(fwd);
  const gc_rev = gcPercent(rev);
  const tm_fwd_wallace = tmWallace(fwd);
  const tm_rev_wallace = tmWallace(rev);
  const tm_fwd_gc      = tmGCFormula(fwd, salt_M);
  const tm_rev_gc      = tmGCFormula(rev, salt_M);
  const tm_fwd_nn      = tmNN(fwd, salt_M, c_M);
  const tm_rev_nn      = tmNN(rev, salt_M, c_M);

  const {eps_seq: eps_fwd, n_avg:n_fwd} = epsFromDNA(fwd);
  const {eps_seq: eps_rev, n_avg:n_rev} = epsFromDNA(rev);

  const msFwd = msFromEps(eps_fwd, c_M, L_cm, n_used, 260);
  const msRev = msFromEps(eps_rev, c_M, L_cm, n_used, 260);

  const tm_fwd_ms = tmMS(msFwd);
  const tm_rev_ms = tmMS(msRev);

  // Summary
  summaryPanel.innerHTML = `
    <div class="section-title">Gene Summary</div>
    <div class="results-grid">
      <div class="result-card">
        <div class="label">Length</div>
        <div class="value">${length_bp} bp</div>
        <div class="small">GC = ${fmt(gc_gene,1)}%</div>
      </div>
      <div class="result-card">
        <div class="label">ORF (frame 1)</div>
        <div class="value">${orf ? protSeq.length + " aa" : "None"}</div>
        <div class="small">${orfInfo}</div>
      </div>
      <div class="result-card">
        <div class="label">ε₂₆₀ (gene)</div>
        <div class="value">${eps_gene.toFixed(0)}</div>
        <div class="small">M⁻¹·cm⁻¹ (base-summed molar absorptivity)</div>
      </div>
      <div class="result-card">
        <div class="label">A₂₆₀ (gene)</div>
        <div class="value">${msGene.A.toFixed(4)}</div>
        <div class="small">α = ${fmt(msGene.alpha,3)} cm⁻¹</div>
      </div>
    </div>
  `;

  // Detail panel
  let detailHTML = "";

  if(orf && protSeq){
    detailHTML += `
      <div class="section-title">Translated Protein (ORF)</div>
      <div class="monospace">${protSeq}</div>
    `;
  }

  detailHTML += `
    <div class="section-title">Maxwell–Scretching EM (Gene at 260 nm)</div>
    <div class="results-grid">
      <div class="result-card">
        <div class="label">κ and ε″ᵣ</div>
        <div class="value">κ = ${fmt(msGene.kappa,6)}</div>
        <div class="small">ε″ᵣ = ${fmt(msGene.epsImag,6)}</div>
      </div>
      <div class="result-card">
        <div class="label">σ and f</div>
        <div class="value">σ = ${fmt(msGene.sigma,3)} cm²</div>
        <div class="small">f (PoC) = ${fmt(msGene.f,3)}</div>
      </div>
    </div>
    <p class="small">
      <b>Non-physicist aside.</b> At 260 nm the gene behaves like a tiny UV antenna.
      The molar absorptivity ε₂₆₀ and concentration set the optical density A₂₆₀ via
      Beer–Lambert’s law. Maxwell–Scretching then maps A₂₆₀ to the absorption
      coefficient α (how strongly light is attenuated per cm), to the extinction
      coefficient κ and imaginary permittivity ε″ᵣ (how lossy the DNA is as an EM
      medium), and finally to a molecular cross-section σ (effective “shadow area”
      per molecule) and an oscillator-strength-like number f. These EM state vectors
      are what the MS framework uses to link spectroscopy to thermodynamics and Tm.
    </p>

    <div class="section-title">Primer Design (simple)</div>
    <p class="small">
      Forward = first ${pLen} bp; Reverse = last ${pLen} bp (reverse-complemented).  
      Tm reported using Wallace, GC%–length–salt, classical nearest-neighbor
      (SantaLucia-style), and a Maxwell–Scretching EM-based Tm (PoC coefficients).
    </p>

    <div class="section-title">Forward Primer</div>
    <div class="monospace">${fwd}</div>
    <div class="results-grid">
      <div class="result-card">
        <div class="label">GC / Tm</div>
        <div class="value">${fmt(gc_fwd,1)}% GC</div>
        <div class="small">
          Tm ≈ ${fmt(tm_fwd_wallace,1)} °C (Wallace)<br>
          Tm ≈ ${fmt(tm_fwd_gc,1)} °C (GC%–length–salt)<br>
          Tm ≈ ${fmt(tm_fwd_nn,1)} °C (NN, PoC)<br>
          Tm ≈ ${fmt(tm_fwd_ms,1)} °C (MS–Tm, PoC)
        </div>
      </div>
      <div class="result-card">
        <div class="label">ε₂₆₀ (fwd)</div>
        <div class="value">${eps_fwd.toFixed(0)}</div>
        <div class="small">A₂₆₀ = ${msFwd.A.toFixed(4)}</div>
      </div>
      <div class="result-card">
        <div class="label">EM params</div>
        <div class="value">κ = ${fmt(msFwd.kappa,6)}</div>
        <div class="small">ε″ᵣ = ${fmt(msFwd.epsImag,6)}</div>
      </div>
    </div>

    <div class="section-title">Reverse Primer</div>
    <div class="monospace">${rev}</div>
    <div class="results-grid">
      <div class="result-card">
        <div class="label">GC / Tm</div>
        <div class="value">${fmt(gc_rev,1)}% GC</div>
        <div class="small">
          Tm ≈ ${fmt(tm_rev_wallace,1)} °C (Wallace)<br>
          Tm ≈ ${fmt(tm_rev_gc,1)} °C (GC%–length–salt)<br>
          Tm ≈ ${fmt(tm_rev_nn,1)} °C (NN, PoC)<br>
          Tm ≈ ${fmt(tm_rev_ms,1)} °C (MS–Tm, PoC)
        </div>
      </div>
      <div class="result-card">
        <div class="label">ε₂₆₀ (rev)</div>
        <div class="value">${eps_rev.toFixed(0)}</div>
        <div class="small">A₂₆₀ = ${msRev.A.toFixed(4)}</div>
      </div>
      <div class="result-card">
        <div class="label">EM params</div>
        <div class="value">κ = ${fmt(msRev.kappa,6)}</div>
        <div class="small">ε″ᵣ = ${fmt(msRev.epsImag,6)}</div>
      </div>
    </div>
  `;

  detailPanel.innerHTML = detailHTML;
}

function downloadReport(){
  const summaryText = document.getElementById("summaryPanel").innerText || "";
  const detailText  = document.getElementById("detailPanel").innerText  || "";
  const txt = "Virtual Gene Machine – Maxwell–Scretching Report\n\n" +
              summaryText + "\n\n" + detailText + "\n";
  const blob = new Blob([txt],{type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Virtual_Gene_Machine_Report.txt";
  a.click();
}

// auto-run demo gene on load
window.addEventListener("DOMContentLoaded", analyze);
</script>

</body>
</html>
